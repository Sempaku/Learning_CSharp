# FileStream. Чтение и запись файла
Класс FileStream представляет возможности по считыванию из файла и записи в файл. Он позволяет работать как с текстовыми файлами, так и с бинарными.

## Создание FileStream
Для создания объекта FileStream можно использовать как конструкторы этого класса, так и статические методы класса File. Конструктор FileStream имеет множество перегруженных версий, из которых отмечу лишь одну, самую простую и используемую:

``` FileStream(string filename, FileMode mode) ```
Здесь в конструктор передается два параметра: путь к файлу и перечисление FileMode. Данное перечисление указывает на режим доступа к файлу и может принимать следующие значения:
- Append: если файл существует, то текст добавляется в конец файл. Если файла нет, то он создается. Файл открывается только для записи.
- Create: создается новый файл. Если такой файл уже существует, то он перезаписывается
- CreateNew: создается новый файл. Если такой файл уже существует, то приложение выбрасывает ошибку
- Open: открывает файл. Если файл не существует, выбрасывается исключение
- OpenOrCreate: если файл существует, он открывается, если нет - создается новый
- Truncate: если файл существует, то он перезаписывается. Файл открывается только для записи.

## Закрытие потока
Класс FileStream для освобождения всех реусрсов, связанных с файлом, реализует интерфейс IDisposable. Соответственно после завершения работы с FileStream необходимо освободить связанный с ним файл вызовом метода Dispose. Для корректного закрытия можно вызвать метод Close(), который вызывает метод Dispose:
```C#
FileStream? fstream = null;
try
{
    fstream = new FileStream("note3.dat", FileMode.OpenOrCreate);
    // операции с fstream
}
catch(Exception ex)
{  }
finally
{
    fstream?.Close();
}
```
Либо можно использовать конструкцию using, которая автоматически освободит все связанные с FileStream ресурсы:

```C#
using (FileStream fstream = new FileStream("note3.dat", FileMode.OpenOrCreate))
{
    // операции с fstream
}
```
## Свойства и методы FileStream
Рассмотрим наиболее важные свойства класса FileStream:
- Свойство Length: возвращает длину потока в байтах
- Свойство Position: возвращает текущую позицию в потоке
- Свойство Name: возвращает абсолютный путь к файлу, открытому в FileStream
Для чтения/записи файлов можно применять следующие методы класса FileStream:
- void CopyTo(Stream destination): копирует данные из текущего потока в поток destination
- Task CopyToAsync(Stream destination): асинхронная версия метода CopyTo
- void Flush(): сбрасывает содержимое буфера в файл
- Task FlushAsync(): асинхронная версия метода Flush
- int Read(byte[] array, int offset, int count): считывает данные из файла в массив байтов и возвращает количество успешно считанных байтов. Принимает три параметра:
    + array - массив байтов, куда будут помещены считываемые из файла данные
    + offset представляет смещение в байтах в массиве array, в который считанные байты будут помещены
    + count - максимальное число байтов, предназначенных для чтения. Если в файле находится меньшее количество байтов, то все они будут считаны.
    + Task<int> ReadAsync(byte[] array, int offset, int count): асинхронная версия метода Read
- long Seek(long offset, SeekOrigin origin): устанавливает позицию в потоке со смещением на количество байт, указанных в параметре offset.
- void Write(byte[] array, int offset, int count): записывает в файл данные из массива байтов. Принимает три параметра:
    + array - массив байтов, откуда данные будут записываться в файл
    + offset - смещение в байтах в массиве array, откуда начинается запись байтов в поток
    + count - максимальное число байтов, предназначенных для записи
- Task WriteAsync(byte[] array, int offset, int count): асинхронная версия метода Write

## Чтение и запись файлов
FileStream представляет доступ к файлам на уровне байтов, поэтому, например, если вам надо считать или записать одну или несколько строк в текстовый файл, то массив байтов надо преобразовать в строки, используя специальные методы. Поэтому для работы с текстовыми файлами применяются другие классы.

В то же время при работе с различными бинарными файлами, имеющими определенную структуру, FileStream может быть очень даже полезен для извлечения определенных порций информации и ее обработки.

Поскольку операции с файлами могут занимать продолжительное время и являются узким местом в работе программы, рекомендуется использовать асинхронные версии методов FileStream. И при записи, и при чтении применяется объект кодировки Encoding.Default из пространства имен System.Text. В данном случае мы используем два его метода: GetBytes для получения массива байтов из строки и GetString для получения строки из массива байтов.

## Произвольный доступ к файлам
Нередко бинарные файлы представляют определенную структуру. И, зная эту структуру, мы можем взять из файла нужную порцию информации или наоброт записать в определенном месте файла определенный набор байтов. Например, в wav-файлах непосредственно звуковые данные начинаются с 44 байта, а до 44 байта идут различные метаданные - количество каналов аудио, частота дискретизации и т.д.

С помощью метода Seek() мы можем управлять положением курсора потока, начиная с которого производится считывание или запись в файл. Этот метод принимает два параметра: offset (смещение) и позиция в файле. Позиция в файле описывается тремя значениями:
- SeekOrigin.Begin: начало файла
- SeekOrigin.End: конец файла
- SeekOrigin.Current: текущая позиция в файле
Курсор потока, с которого начинается чтение или запись, смещается вперед на значение offset относительно позиции, указанной в качестве второго параметра. Смещение может быть отрицательным, тогда курсор сдвигается назад, если положительное - то вперед.

